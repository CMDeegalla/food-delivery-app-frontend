<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Checkout - FoodGo </title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    .iphone {
      width: 390px;
      height: 844px;
      border-radius: 40px;
      overflow: hidden;
      border: 2px solid black;
      background: #fafafa;
      position: relative;
    }

    /* Accessibility */
    .sr-only { position:absolute; width:1px; height:1px; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); }

    .iphone.high-contrast { background:#1b1838 !important; color:#fff !important; }
    .iphone.high-contrast * { color:#fff !important; background-color:transparent !important; }

    .iphone.large-text { font-size:1.08rem; }
    .iphone.large-text * { font-size:inherit; }

    .iphone.dyslexia-mode { font-family:system-ui,sans-serif; letter-spacing:0.03em; line-height:1.4; }

    /* Payment highlight */
    .pay-selected { background:#2b2b3a !important; color:white !important; }
  </style>
</head>

<body class="bg-gray-900 flex justify-center items-center h-screen">

<div class="iphone" role="application" aria-label="Checkout screen">

  <!-- Screen reader alert -->
  <div id="announce" class="sr-only" aria-live="polite"></div>

  <!-- HEADER -->
  <header class="absolute top-0 left-0 w-full z-20 bg-white/40 backdrop-blur-xl p-5 flex justify-between items-center">
    <button onclick="history.back()"
      class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center focus-visible:ring-2 ring-green-500"
      aria-label="Go back">
      <span class="material-icons text-gray-700">arrow_back</span>
    </button>

    <h1 class="text-lg font-extrabold tracking-tight">Checkout</h1>

    <!-- Accessibility button -->
    <button id="accBtn"
      class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center focus-visible:ring-2 ring-green-500"
      aria-label="Accessibility options"
      aria-expanded="false">
      <span class="material-icons text-gray-700">accessibility_new</span>
    </button>
  </header>

  <!-- Accessibility Panel -->
  <section id="accPanel"
    class="absolute top-20 right-5 bg-white rounded-xl shadow-xl p-3 text-xs w-48 hidden z-30">
    <p class="font-semibold mb-2">Accessibility</p>
    <label class="flex items-center gap-2 mb-1"><input type="checkbox" id="toggleHC"> High contrast</label>
    <label class="flex items-center gap-2 mb-1"><input type="checkbox" id="toggleLT"> Larger text</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="toggleDX"> Dyslexia-friendly</label>
  </section>

  <!-- MAIN CONTENT -->
  <main class="px-6 pt-24 pb-40 overflow-y-auto">

    <!-- ORDER SUMMARY -->
    <p class="font-bold text-gray-700 text-base mb-3">Order Summary</p>

    <div id="orderBox" class="bg-white rounded-xl shadow-md p-4 flex justify-between items-center">

    </div>

    <!-- PRICE DETAILS -->
    <div class="mt-6 space-y-3">
      <div class="flex justify-between text-sm">
        <span class="text-gray-600">Subtotal</span>
        <span id="subtotal" class="font-semibold">$0.00</span>
      </div>

      <div class="flex justify-between text-sm">
        <span class="text-gray-600">Delivery Fee</span>
        <span id="delivery" class="font-semibold">$1.50</span>
      </div>

      <div class="flex justify-between text-sm">
        <span class="text-gray-600">Tax (2%)</span>
        <span id="tax" class="font-semibold">$0.00</span>
      </div>

      <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
        <span>Total</span>
        <span id="total" class="text-green-600">$0.00</span>
      </div>
    </div>

    <!-- PAYMENT METHODS -->
    <p class="mt-8 font-bold text-gray-700 mb-3">Payment Method</p>

    <div id="payCard1"
      class="pay-card bg-white rounded-xl shadow p-4 flex justify-between items-center cursor-pointer mb-3">
      <div class="flex items-center gap-3">
        <span class="material-icons text-orange-400">credit_card</span>
        <p class="text-sm font-semibold">Credit / Debit Card</p>
      </div>
      <span class="material-icons text-gray-400">chevron_right</span>
    </div>

    <div id="payCard2"
      class="pay-card bg-white rounded-xl shadow p-4 flex justify-between items-center cursor-pointer">
      <div class="flex items-center gap-3">
        <span class="material-icons text-orange-400">account_balance_wallet</span>
        <p class="text-sm font-semibold">Cash on Delivery</p>
      </div>
      <span class="material-icons text-gray-400">chevron_right</span>
    </div>

  </main>

  <!-- PAY NOW -->
  <footer class="absolute bottom-0 left-0 right-0 bg-white shadow-xl px-6 py-6 rounded-t-3xl">
    <button id="payNowBtn"
      class="w-full bg-green-700 text-white py-3 rounded-xl font-bold active:scale-95 focus-visible:ring-2 ring-white"
      aria-label="Pay now and complete order">
      Pay Now
    </button>
  </footer>

</div>

<script>
/*
   Helper: Announce for SR
 */
function say(msg){ document.getElementById("announce").textContent = msg; }

/* -------------------------
   Load Order (from product)
------------------------- */
const order = JSON.parse(localStorage.getItem("currentOrder"));

if (!order) {
  alert("No order found!");
  window.location.href = "index.html";
}

/* ORDER BOX */
document.getElementById("orderBox").innerHTML = `
  <div class="flex items-center gap-3">
    <img src="${order.img}" class="w-14 h-14 rounded-xl object-cover" alt="Food item">
    <div>
      <p class="font-semibold text-sm">${order.name}</p>
      <p class="text-xs text-gray-500">Qty: ${order.qty}</p>
    </div>
  </div>

  <p class="font-bold text-sm">$${(order.qty * order.price).toFixed(2)}</p>
`;

/* PRICE CALCULATION */
let subtotal = order.qty * order.price;
let delivery = 1.50;
let tax = subtotal * 0.02;
let total = subtotal + delivery + tax;

document.getElementById("subtotal").textContent = `$${subtotal.toFixed(2)}`;
document.getElementById("delivery").textContent = `$${delivery.toFixed(2)}`;
document.getElementById("tax").textContent = `$${tax.toFixed(2)}`;
document.getElementById("total").textContent = `$${total.toFixed(2)}`;

/* PAYMENT SELECTION */
let selectedPay = 1;

function updatePaymentUI() {
  document.querySelectorAll(".pay-card").forEach(c => c.classList.remove("pay-selected"));
  document.getElementById("payCard" + selectedPay).classList.add("pay-selected");
  say("Payment method selected: " + (selectedPay === 1 ? "Card" : "Cash on Delivery"));
}

document.getElementById("payCard1").onclick = () => { selectedPay = 1; updatePaymentUI(); };
document.getElementById("payCard2").onclick = () => { selectedPay = 2; updatePaymentUI(); };

updatePaymentUI();

/* -------------------------
   ORDER HISTORY (AUTO SAVE)
------------------------- */
const ORDERS_KEY = "foodgo_orders";

function getOrders() {
  try { return JSON.parse(localStorage.getItem(ORDERS_KEY)) || []; }
  catch { return []; }
}

function saveOrders(orders) {
  localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
}

function addOrderToHistory(order, totalAmount, selectedPay) {
  const paymentName = selectedPay === 1 ? "Card" : "Cash on Delivery";

  const newOrder = {
    id: "ORD" + Math.floor(Math.random() * 1000000),
    restaurant: order.restaurantName || "FoodGo",
    items: [`${order.qty}x ${order.name}`],
    total: Number(totalAmount),
    date: new Date().toLocaleString(),
    status: selectedPay === 2 ? "Cash on Delivery" : "Preparing",
    payment: paymentName,
    img: order.img
  };

  const orders = getOrders();
  orders.push(newOrder);
  saveOrders(orders);

  return newOrder;
}

/* PAY NOW */
document.getElementById("payNowBtn").onclick = () => {
  // Store last payment for success page use
  localStorage.setItem("lastPayment", JSON.stringify({
    order: order,
    total: total,
    payment: selectedPay
  }));

  // ✅ Save order to order history
  addOrderToHistory(order, total, selectedPay);

  // ✅ Clear currentOrder to avoid duplicates
  localStorage.removeItem("currentOrder");

  say("Payment processed. Redirecting to success page.");
  window.location.href = "success.html";
};

/* 
   Accessibility panel handler
 */
const iphone = document.querySelector(".iphone");
const accBtn = document.getElementById("accBtn");
const accPanel = document.getElementById("accPanel");

accBtn.onclick = () => {
  const willOpen = accPanel.classList.contains("hidden");
  accPanel.classList.toggle("hidden", !willOpen);
  accBtn.setAttribute("aria-expanded", willOpen ? "true" : "false");
};

document.getElementById("toggleHC").onchange = e => iphone.classList.toggle("high-contrast", e.target.checked);
document.getElementById("toggleLT").onchange = e => iphone.classList.toggle("large-text", e.target.checked);
document.getElementById("toggleDX").onchange = e => iphone.classList.toggle("dyslexia-mode", e.target.checked);

</script>

</body>
</html>
